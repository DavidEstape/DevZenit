<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Liquidación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para generar el PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom styles to hide number input arrows for a cleaner look */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 font-sans text-slate-800">

    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden my-8">
        
        <!-- Header -->
        <div class="bg-blue-600 px-8 py-6 text-white">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-calculator"></i>
                Calculadora de Simulación Liquidación
            </h1>
            <p class="text-blue-100 text-sm mt-1">Introduce los datos iniciales para calcular los importes</p>
        </div>

        <div class="p-8">
            <!-- Form Section -->
            <form onsubmit="event.preventDefault(); calcular();">
                
                <!-- Fila 0: Switch de Modo de Cálculo -->
                <div class="flex justify-center mb-8">
                    <div class="bg-slate-100 p-1 rounded-lg inline-flex relative">
                        <button type="button" id="btnModeBruto" onclick="setMode('bruto')" class="px-5 py-2.5 rounded-md bg-white shadow-sm text-sm font-bold text-slate-800 transition-all z-10">
                            <i class="fa-solid fa-arrow-down-wide-short mr-2 text-slate-400"></i>De Bruto a Neto
                        </button>
                        <button type="button" id="btnModeNeto" onclick="setMode('neto')" class="px-5 py-2.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-all z-10">
                            <i class="fa-solid fa-bullseye mr-2"></i>Objetivo Neto
                        </button>
                    </div>
                </div>

                <!-- Fila 1: Parámetros principales -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    
                    <!-- Input: Importe Principal (Cambia de nombre dinámicamente) -->
                    <div>
                        <label id="lblImportePrincipal" for="inputImportePrincipal" class="block text-sm font-bold text-blue-600 mb-2 transition-colors">
                            Importe venta bruto
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-sm">€</span>
                            </div>
                            <input type="number" id="inputImportePrincipal" placeholder="75,00" step="0.01" min="0" required
                                class="pl-8 w-full rounded-lg border-2 border-blue-200 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-blue-50/30">
                        </div>
                        <p id="errorImporteBruto" class="text-red-500 text-xs mt-1 hidden">El importe mínimo es 75€.</p>
                        <p id="warningImporteNeto" class="text-amber-500 text-xs mt-1 hidden">El neto es inferior al mínimo legal. Se ha ajustado.</p>
                    </div>

                    <!-- Input: Nº días -->
                    <div>
                        <label for="inputDias" class="block text-sm font-medium text-slate-700 mb-2">
                            Nº días
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-regular fa-calendar text-slate-400"></i>
                            </div>
                            <input type="number" id="inputDias" value="1" min="1" step="1" required
                                class="pl-9 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        </div>
                    </div>

                    <!-- Input: % IRPF -->
                    <div>
                        <label for="inputIRPF" class="block text-sm font-medium text-slate-700 mb-2">
                            % IRPF
                        </label>
                        <div class="relative">
                            <input type="number" id="inputIRPF" placeholder="2,00" step="0.1" min="2" value="2" required
                                class="pr-8 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-sm">%</span>
                            </div>
                        </div>
                        <p id="errorIRPF" class="text-red-500 text-xs mt-1 hidden">El IRPF mínimo es 2%.</p>
                    </div>

                </div>

                <!-- Fila 2: Kilometraje y Dietas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Input: Kilometraje -->
                    <div>
                        <label for="inputKilometraje" class="block text-sm font-medium text-slate-700 mb-2">
                            Kilometraje (Diario)
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-car text-slate-400"></i>
                            </div>
                            <input type="number" id="inputKilometraje" placeholder="0" min="0" step="1"
                                class="pl-9 pr-12 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-sm">km</span>
                            </div>
                        </div>
                    </div>

                    <!-- Input: Dietas -->
                    <div>
                        <label for="inputDietas" class="block text-sm font-medium text-slate-700 mb-2">
                            Días de dieta
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-utensils text-slate-400"></i>
                            </div>
                            <input type="number" id="inputDietas" placeholder="0" min="0" step="1"
                                class="pl-9 pr-14 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-sm">días</span>
                            </div>
                        </div>
                    </div>

                    <!-- Input: Tipo de Dieta -->
                    <div>
                        <label for="inputTipoDieta" class="block text-sm font-medium text-slate-700 mb-2">
                            Tipo de dieta
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-location-dot text-slate-400"></i>
                            </div>
                            <select id="inputTipoDieta" class="pl-9 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors appearance-none bg-white cursor-pointer">
                                <option value="28.0736">Territorio español</option>
                                <option value="50.6105">Fuera de territorio español</option>
                                <option value="56.1473">Pernocta territorio español</option>
                                <option value="96.1578">Pernocta fuera territorio español</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <i class="fa-solid fa-chevron-down text-slate-400 text-sm"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fila 3: Gastos justificados -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Input: Gastos justificados -->
                    <div>
                        <label for="inputGastosJustificados" class="block text-sm font-medium text-slate-700 mb-2">
                            Gastos justificados (Globales)
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-receipt text-slate-400"></i>
                            </div>
                            <input type="number" id="inputGastosJustificados" placeholder="0,00" min="0" step="0.01"
                                class="pl-9 pr-8 w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <span class="text-slate-500 sm:text-sm">€</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fila 5: Alquiler de Material (Desplegable) -->
                <div class="mb-10 bg-slate-50 border border-slate-200 rounded-xl overflow-hidden transition-all duration-300">
                    <!-- Cabecera / Botón Desplegable -->
                    <button type="button" onclick="toggleMaterial()" class="w-full px-6 py-5 flex justify-between items-center text-left hover:bg-slate-100 transition-colors focus:outline-none">
                        <div class="flex items-center justify-between w-full pr-6">
                            <h3 id="materialHeaderTitle" class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-guitar text-slate-400"></i>
                                <span>Añadir material de alquiler propio</span>
                            </h3>
                            <span id="materialHeaderTotal" class="text-sm font-bold text-slate-900 hidden">0,00 €</span>
                        </div>
                        <i id="materialChevron" class="fa-solid fa-chevron-down text-slate-400 transition-transform duration-300 flex-shrink-0"></i>
                    </button>
                    
                    <!-- Contenido Colapsable -->
                    <div id="materialContent" class="hidden px-6 pb-6 pt-2">
                        <div class="flex flex-col md:flex-row gap-4 mb-4 items-end">
                            <div class="flex-grow w-full">
                                <label for="selectMaterial" class="block text-xs font-medium text-slate-500 mb-1">
                                    Instrumento / Material
                                </label>
                                <div class="relative">
                                    <select id="selectMaterial" class="w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none bg-white cursor-pointer">
                                        <option value="105.2632">Altavoces (105,26€)</option>
                                        <option value="73.6842">Bajos y complementos (73,68€)</option>
                                        <option value="105.2632">Batería acústica (105,26€)</option>
                                        <option value="105.2632">Batería eléctrica (105,26€)</option>
                                        <option value="5.2632">Cables (5,26€)</option>
                                        <option value="84.2105">Clarinete (84,21€)</option>
                                        <option value="105.2632">Contrabajo (105,26€)</option>
                                        <option value="73.6842">Guitarra acústica (73,68€)</option>
                                        <option value="63.1579">Guitarra clásica (63,16€)</option>
                                        <option value="105.2632">Guitarra eléctrica (105,26€)</option>                                 
                                        <option value="52.6316">Micrófono (52,63€)</option>
                                        <option value="63.1579">Ordenador (63,16€)</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                        <i class="fa-solid fa-chevron-down text-slate-400 text-sm"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="w-full md:w-48 relative">
                                <label for="inputMaterialQty" class="block text-xs font-medium text-slate-500 mb-1 whitespace-nowrap">
                                    Num. Instrumentos/día
                                </label>
                                <input type="number" id="inputMaterialQty" value="1" min="1" step="1" title="Cantidad"
                                    class="w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                            </div>
                            <button type="button" onclick="agregarMaterial()" class="mb-[1px] bg-slate-800 hover:bg-slate-900 text-white font-medium px-6 py-2.5 rounded-lg transition-colors flex justify-center items-center gap-2 h-[46px]">
                                <i class="fa-solid fa-plus text-sm"></i> Añadir
                            </button>
                        </div>
                        
                        <!-- Lista de material añadido -->
                        <ul id="listaMaterialUI" class="space-y-2 mb-4">
                            <li class="text-sm text-slate-400 italic py-2 text-center">Ningún material añadido</li>
                        </ul>
                        
                        <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                            <span class="text-sm font-medium text-slate-600">Total alquiler diario:</span>
                            <span class="text-lg font-bold text-slate-900" id="totalMaterialUI">0,00 €</span>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="flex justify-center mb-10">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-10 rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2 active:scale-95 text-lg">
                        <i class="fa-solid fa-play text-sm"></i>
                        <span id="btnCalculateText">Calcular Liquidación</span>
                    </button>
                </div>
            </form>

            <!-- Divider -->
            <div class="border-t border-slate-200 mb-8"></div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden relative">
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice-dollar text-slate-400"></i>
                        Desglose de la Liquidación Zenit
                    </h2>
                    <!-- Botón PDF oculto temporalmente (As en la manga) 
                    <button id="btnDownloadPDF" onclick="generarPDF()" type="button" class="bg-slate-800 hover:bg-slate-900 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2 shadow-sm">
                        <i class="fa-solid fa-file-pdf text-red-400"></i> Descargar PDF
                    </button>
                    -->
                </div>

                <!-- Banner Informativo Goal Seek -->
                <div id="goalSeekBanner" class="hidden mb-6 bg-emerald-50 border border-emerald-200 rounded-lg p-4 flex items-center gap-3">
                    <i class="fa-solid fa-bullseye text-emerald-500 text-xl"></i>
                    <div>
                        <p class="text-sm text-emerald-800 m-0">
                            Para conseguir un neto de <strong id="gsNetoTarget">0,00 €</strong>, 
                            el importe bruto de facturación deberia ser de <strong id="gsBrutoResult" class="text-lg">0,00 €</strong>.
                        </p>
                    </div>
                </div>

                <!-- Resumen oculto para el PDF -->
                <div id="pdfSummary" class="hidden mb-8 p-6 bg-slate-50 border border-slate-200 rounded-xl">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 border-b border-slate-200 pb-2">Parámetros Iniciales de Cálculo</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm" id="pdfSummaryContent">
                        <!-- JS injects here -->
                    </div>
                </div>

                <!-- MATRIZ DE DESGLOSE (GRID BASED) -->
                <div id="multiDayView" class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm bg-white">
                    <div class="min-w-[800px] flex flex-col">
                        <!-- Cabecera Tabla -->
                        <div class="bg-slate-50 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                            <div class="py-3 px-4 font-semibold">Día / Concepto</div>
                            <div class="py-3 px-4 font-semibold text-right">Importe</div>
                            <div class="py-3 px-4 font-semibold text-right">Comisión</div>
                            <div class="py-3 px-4 font-semibold text-right">Base liquidable</div>
                            <div class="py-3 px-4 font-semibold text-right">Seg. Soc.</div>
                            <div class="py-3 px-4 font-semibold text-right">IRPF</div>
                            <div class="py-3 px-4 font-semibold text-right">A liquidar</div>
                        </div>
                        
                        <!-- Contenido Dinámico -->
                        <div id="multiDayBody" class="flex flex-col">
                            <!-- JS generates rows here -->
                        </div>
                        
                        <!-- Totales -->
                        <div id="multiDayFoot" class="bg-blue-50/50 border-t-2 border-slate-200 break-inside-avoid">
                            <!-- JS generates totals here -->
                        </div>
                    </div>
                </div>

                <!-- Divider Taiman -->
                <div id="taimanDivider" class="border-t border-slate-200 my-8 hidden"></div>

                <!-- Taiman Section (GRID BASED) -->
                <div id="taimanSection" class="hidden break-inside-avoid">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-guitar text-slate-400"></i>
                        Desglose de la Liquidación Taiman
                    </h2>
                    
                    <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm bg-white">
                        <div class="min-w-[800px] flex flex-col">
                            <!-- Cabecera Tabla Taiman -->
                            <div class="bg-slate-50 text-slate-600 text-xs uppercase tracking-wider border-b border-slate-200 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                                <div class="py-3 px-4 font-semibold">Concepto</div>
                                <div class="py-3 px-4 font-semibold text-right">Importe</div>
                                <div class="py-3 px-4 font-semibold text-right">Comisión</div>
                                <div class="py-3 px-4 font-semibold text-right">Base liquidable</div>
                                <div class="py-3 px-4 font-semibold text-right text-transparent select-none">-</div>
                                <div class="py-3 px-4 font-semibold text-right">7% IRPF</div>
                                <div class="py-3 px-4 font-semibold text-right">A liquidar</div>
                            </div>
                            
                            <!-- Contenido Taiman -->
                            <div class="bg-purple-50/50">
                                <div class="py-4 px-4 hover:bg-purple-100/50 transition-colors text-sm grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                                    <div class="font-bold text-purple-600 uppercase text-xs tracking-wider flex items-center"><i class="fa-solid fa-file-invoice text-purple-500 mr-2"></i>Liquidación Taiman</div>
                                    <div class="text-right tabular-nums font-bold text-slate-900" id="resTaimanImporte">0,00 €</div>
                                    <div class="text-right tabular-nums font-bold text-red-600" id="resTaimanComision">0,00 €</div>
                                    <div class="text-right tabular-nums font-bold text-slate-900" id="resTaimanBaseLiq">0,00 €</div>
                                    <div class="text-right tabular-nums font-bold text-slate-400">-</div>
                                    <div class="text-right tabular-nums font-bold text-red-600" id="resTaimanIRPF">0,00 €</div>
                                    <div class="text-right tabular-nums font-bold text-purple-700 text-lg" id="resTaimanALiquidar">0,00 €</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        // Formateador de moneda para euros (formato español)
        const currencyFormatter = new Intl.NumberFormat('es-ES', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2
        });

        // --- GESTIÓN MODO DE CÁLCULO (BRUTO/NETO) ---
        let calcMode = 'bruto';

        function setMode(mode) {
            calcMode = mode;
            const btnBruto = document.getElementById('btnModeBruto');
            const btnNeto = document.getElementById('btnModeNeto');
            const lblImporte = document.getElementById('lblImportePrincipal');
            const btnCalc = document.getElementById('btnCalculateText');
            const warningNeto = document.getElementById('warningImporteNeto');
            const errorBruto = document.getElementById('errorImporteBruto');

            errorBruto.classList.add('hidden');
            warningNeto.classList.add('hidden');

            if (mode === 'bruto') {
                btnBruto.className = "px-5 py-2.5 rounded-md bg-white shadow-sm text-sm font-bold text-slate-800 transition-all z-10";
                btnBruto.innerHTML = '<i class="fa-solid fa-arrow-down-wide-short mr-2 text-blue-600"></i>De Bruto a Neto';
                btnNeto.className = "px-5 py-2.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-all z-10";
                btnNeto.innerHTML = '<i class="fa-solid fa-bullseye mr-2"></i>Objetivo Neto';
                
                lblImporte.textContent = "Importe venta bruto";
                lblImporte.className = "block text-sm font-bold text-blue-600 mb-2 transition-colors";
                btnCalc.textContent = "Calcular Liquidación";
            } else {
                btnNeto.className = "px-5 py-2.5 rounded-md bg-white shadow-sm text-sm font-bold text-slate-800 transition-all z-10";
                btnNeto.innerHTML = '<i class="fa-solid fa-bullseye mr-2 text-emerald-600"></i>Objetivo Neto';
                btnBruto.className = "px-5 py-2.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-all z-10";
                btnBruto.innerHTML = '<i class="fa-solid fa-arrow-down-wide-short mr-2"></i>De Bruto a Neto';
                
                lblImporte.textContent = "Total Neto a Percibir";
                lblImporte.className = "block text-sm font-bold text-emerald-600 mb-2 transition-colors";
                btnCalc.textContent = "Calcular importe bruto";
            }
        }

        // --- GESTIÓN DINÁMICA DE ALQUILER DE MATERIAL ---
        let listaMaterial = [];

        function toggleMaterial() {
            const content = document.getElementById('materialContent');
            const chevron = document.getElementById('materialChevron');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        function agregarMaterial() {
            const select = document.getElementById('selectMaterial');
            const qtyInput = document.getElementById('inputMaterialQty');
            const qty = parseInt(qtyInput.value) || 1;
            const price = parseFloat(select.value);
            const name = select.options[select.selectedIndex].text.split(' (')[0]; 

            listaMaterial.push({ name, price, qty });
            renderMaterial();
            qtyInput.value = 1; 
        }

        function eliminarMaterial(index) {
            listaMaterial.splice(index, 1);
            renderMaterial();
        }

        function renderMaterial() {
            const ul = document.getElementById('listaMaterialUI');
            const totalUI = document.getElementById('totalMaterialUI');
            ul.innerHTML = '';
            let total = 0;

            listaMaterial.forEach((item, index) => {
                const sum = item.price * item.qty;
                total += sum;
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-lg border border-slate-100 shadow-sm text-sm';
                li.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="bg-slate-100 text-slate-600 font-bold px-2 py-0.5 rounded text-xs">${item.qty}x</span>
                        <span class="font-medium text-slate-700">${item.name}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-slate-600 tabular-nums">${currencyFormatter.format(sum)}</span>
                        <button type="button" onclick="eliminarMaterial(${index})" class="text-red-400 hover:text-red-600 transition-colors" title="Eliminar">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
                ul.appendChild(li);
            });

            if (listaMaterial.length === 0) {
                ul.innerHTML = '<li class="text-sm text-slate-400 italic py-2 text-center">Ningún material añadido</li>';
            }

            totalUI.textContent = currencyFormatter.format(total);

            const headerTitleSpan = document.querySelector('#materialHeaderTitle span');
            const headerTotalSpan = document.getElementById('materialHeaderTotal');
            
            if (listaMaterial.length > 0) {
                headerTitleSpan.textContent = 'Modificar material de alquiler propio';
                headerTotalSpan.textContent = currencyFormatter.format(total);
                headerTotalSpan.classList.remove('hidden');
            } else {
                headerTitleSpan.textContent = 'Añadir material de alquiler propio';
                headerTotalSpan.classList.add('hidden');
            }
        }

        // --- FUNCIONES DE CÁLCULO ---
        function calcularDia(bruto, porcentajeIRPF) {
            const comision = bruto * 0.05; 
            const coste = bruto - comision; 
            
            let segSocial = 0;
            if (bruto <= 75) {
                segSocial = 21;
            } else if (bruto <= 477.25) {
                const intermedio1 = coste * 0.25009;
                const intermedio2 = (coste - intermedio1) * 0.0655;
                segSocial = intermedio1 + intermedio2 + 2.5;
            } else if (bruto <= 729.421578947369) {
                segSocial = 138.86;
            } else if (bruto <= 1250.26368421053) {
                segSocial = 176.49;
            } else if (bruto <= 2023.02157894737) {
                segSocial = 221.41;
            } else if (bruto <= 2287.30578947368) {
                segSocial = 288.52;
            } else if (bruto <= 2732.66368421053) {
                segSocial = 294.67;
            } else if (bruto <= 3158.85315789474) {
                segSocial = 300.77;
            } else {
                segSocial = 310.27;
            }

            const baseLiq = coste - segSocial; 
            const irpf = baseLiq * (porcentajeIRPF / 100); 
            const aLiquidar = baseLiq - irpf; 

            return { bruto, comision, coste, segSocial, baseLiq, irpf, aLiquidar };
        }

        // --- MOTOR DE SIMULACIÓN (Puro, sin UI) ---
        function simularEscenario(importeBrutoPrueba, params) {
            let bucket = importeBrutoPrueba - (params.dias * 75);
            let dData = [];

            for (let i = 1; i <= params.dias; i++) {
                dData.push({ dia: i, cache: 75, km: 0, dieta: 0, alquiler: 0 });
            }

            if (params.km > 0) {
                let reqKm = params.km * 0.2737;
                let totalReqKm = reqKm * params.dias;
                let availableKm = Math.min(totalReqKm, bucket);
                let perDayKm = availableKm / params.dias; 
                for (let i = 0; i < params.dias; i++) {
                    dData[i].km = perDayKm;
                    bucket -= perDayKm;
                }
                bucket = Math.max(0, bucket); 
            }

            if (params.dietas > 0) {
                let totalReqDieta = params.tarifaDieta * params.dietas;
                let availableDieta = Math.min(totalReqDieta, bucket);
                let perDayDieta = availableDieta / params.dietas; 
                for (let i = 0; i < params.dietas; i++) {
                    dData[i].dieta = perDayDieta;
                    bucket -= perDayDieta;
                }
                bucket = Math.max(0, bucket);
            }

            let gastosJustificadosSim = 0;
            if (params.gastos > 0 && bucket > 0) {
                gastosJustificadosSim = Math.min(params.gastos, bucket);
                bucket -= gastosJustificadosSim;
            }

            if (params.totalAlquiler > 0) {
                for (let i = 0; i < params.dias; i++) {
                    let alquilerDiaBruto = Math.min(params.totalAlquiler, bucket);
                    dData[i].alquiler = alquilerDiaBruto;
                    bucket -= alquilerDiaBruto;
                }
                bucket = Math.max(0, bucket);
            }

            if (bucket > 0) {
                dData[dData.length - 1].cache += bucket;
            }

            // Calcular totales de la simulación
            let totalZenitALiquidar = 0;
            let dayResults = [];
            let totalsZenit = { bruto: 0, comision: 0, coste: 0, segSocial: 0, irpf: 0, aLiquidar: 0 };

            for (let i = 0; i < dData.length; i++) {
                const res = calcularDia(dData[i].cache, params.irpf);
                totalsZenit.bruto += res.bruto;
                totalsZenit.comision += res.comision;
                totalsZenit.coste += res.coste;
                totalsZenit.segSocial += res.segSocial;
                totalsZenit.irpf += res.irpf;
                totalsZenit.aLiquidar += res.aLiquidar;

                let dayObj = { cache: res, dataOriginal: dData[i] };

                if (dData[i].km > 0) {
                    const c = dData[i].km * 0.05; const bl = dData[i].km - c;
                    totalsZenit.bruto += dData[i].km; totalsZenit.comision += c; totalsZenit.coste += bl; totalsZenit.aLiquidar += bl;
                }
                if (dData[i].dieta > 0) {
                    const c = dData[i].dieta * 0.05; const bl = dData[i].dieta - c;
                    totalsZenit.bruto += dData[i].dieta; totalsZenit.comision += c; totalsZenit.coste += bl; totalsZenit.aLiquidar += bl;
                }
                if (dData[i].alquiler > 0) {
                    const c = dData[i].alquiler * 0.05; const bl = dData[i].alquiler - c;
                    totalsZenit.bruto += dData[i].alquiler; totalsZenit.comision += c; totalsZenit.coste += bl; 
                }
                dayResults.push(dayObj);
            }

            let gastosRes = null;
            if (gastosJustificadosSim > 0) {
                const c = gastosJustificadosSim * 0.05; const bl = gastosJustificadosSim - c;
                totalsZenit.bruto += gastosJustificadosSim; totalsZenit.comision += c; totalsZenit.coste += bl; totalsZenit.aLiquidar += bl;
                gastosRes = { bruto: gastosJustificadosSim, comision: c, baseLiq: bl };
            }

            let totalAllocatedMaterial = dData.reduce((acc, curr) => acc + curr.alquiler, 0);
            let taimanNeto = 0;
            let taimanRes = null;
            
            if (totalAllocatedMaterial > 0) {
                const importe = totalAllocatedMaterial - (totalAllocatedMaterial * 0.05); 
                const comision = importe * 0.05;
                const baseLiq = importe - comision;
                const irpf = baseLiq * 0.07;
                taimanNeto = baseLiq - irpf;
                taimanRes = { importe, comision, baseLiq, irpf, aLiquidar: taimanNeto };
            }

            return {
                brutoEvaluado: importeBrutoPrueba,
                netoCalculado: totalsZenit.aLiquidar + taimanNeto,
                dayResults,
                gastosRes,
                taimanRes,
                totalsZenit
            };
        }

        function calcular() {
            // 1. OBTENER PARÁMETROS FIJOS
            let inputPrincipal = parseFloat(document.getElementById('inputImportePrincipal').value) || 0;
            let inputDias = parseInt(document.getElementById('inputDias').value) || 1; 
            let inputIRPF = parseFloat(document.getElementById('inputIRPF').value) || 0;
            let inputKilometraje = parseFloat(document.getElementById('inputKilometraje').value) || 0;
            let inputDietas = parseInt(document.getElementById('inputDietas').value) || 0;
            let inputGastos = parseFloat(document.getElementById('inputGastosJustificados').value) || 0;
            let tarifaDieta = parseFloat(document.getElementById('inputTipoDieta').value) || 28.0736;
            let totalAlquiler = listaMaterial.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
            const errorImporteBruto = document.getElementById('errorImporteBruto');
            const warningImporteNeto = document.getElementById('warningImporteNeto');
            
            errorImporteBruto.classList.add('hidden');
            warningImporteNeto.classList.add('hidden');

            if (inputDias < 1) { inputDias = 1; document.getElementById('inputDias').value = 1; }
            if (inputDietas > inputDias) { inputDietas = inputDias; document.getElementById('inputDietas').value = inputDias; }
            if (inputIRPF < 2) { inputIRPF = 2; document.getElementById('inputIRPF').value = 2; }

            const params = {
                dias: inputDias, irpf: inputIRPF, km: inputKilometraje, 
                dietas: inputDietas, tarifaDieta: tarifaDieta, 
                gastos: inputGastos, totalAlquiler: totalAlquiler
            };

            const minBrutoRequerido = inputDias * 75;
            let brutoFinal = 0;
            let resultadoCalculo = null;

            // 2. EJECUTAR LÓGICA SEGÚN MODO
            if (calcMode === 'bruto') {
                if (inputPrincipal < minBrutoRequerido && document.getElementById('inputImportePrincipal').value !== "") {
                    inputPrincipal = minBrutoRequerido; 
                    document.getElementById('inputImportePrincipal').value = minBrutoRequerido; 
                    errorImporteBruto.textContent = `El importe mínimo para ${inputDias} día(s) es ${minBrutoRequerido}€.`;
                    errorImporteBruto.classList.remove('hidden'); 
                }
                brutoFinal = inputPrincipal;
                resultadoCalculo = simularEscenario(brutoFinal, params);
                
                document.getElementById('goalSeekBanner').classList.add('hidden');
                
            } else {
                // MODO BUSCAR OBJETIVO (Goal Seek / Binary Search)
                let objetivoNeto = inputPrincipal;
                let simMinima = simularEscenario(minBrutoRequerido, params);
                
                if (objetivoNeto <= simMinima.netoCalculado) {
                    // El neto deseado es demasiado bajo, no se puede conseguir legalmente
                    warningImporteNeto.classList.remove('hidden');
                    brutoFinal = minBrutoRequerido;
                    resultadoCalculo = simMinima;
                } else {
                    // Búsqueda binaria
                    let low = minBrutoRequerido;
                    let high = objetivoNeto * 3 + minBrutoRequerido + 1000; // Cota superior segura
                    let iter = 0;
                    
                    while (low <= high && iter < 100) {
                        let mid = (low + high) / 2;
                        let sim = simularEscenario(mid, params);
                        
                        if (Math.abs(sim.netoCalculado - objetivoNeto) < 0.005) {
                            brutoFinal = mid;
                            resultadoCalculo = sim;
                            break;
                        }
                        if (sim.netoCalculado < objetivoNeto) {
                            low = mid;
                        } else {
                            high = mid;
                        }
                        brutoFinal = mid;
                        resultadoCalculo = sim;
                        iter++;
                    }
                }
                
                // Mostrar banner de resultados Goal Seek
                document.getElementById('gsNetoTarget').textContent = currencyFormatter.format(objetivoNeto);
                document.getElementById('gsBrutoResult').textContent = currencyFormatter.format(brutoFinal);
                document.getElementById('goalSeekBanner').classList.remove('hidden');
            }

            // 3. MOSTRAR SECCIÓN DE RESULTADOS Y RENDERIZAR
            document.getElementById('resultsSection').classList.remove('hidden');

            // Preparar PDF Summary
            const dietSelect = document.getElementById('inputTipoDieta');
            const dietText = dietSelect.options[dietSelect.selectedIndex].text;
            let materialSummary = listaMaterial.length > 0 ? listaMaterial.map(m => `${m.qty}x ${m.name}`).join(', ') : 'Ningún material añadido';

            const summaryHtml = `
                <div><span class="text-slate-500 block text-xs">Modo de Cálculo</span><span class="font-bold text-slate-800">${calcMode === 'bruto' ? 'A partir de Venta Bruta' : 'A partir de Objetivo Neto'}</span></div>
                <div><span class="text-slate-500 block text-xs">${calcMode === 'bruto' ? 'Importe Venta Bruto' : 'Objetivo Neto deseado'}</span><span class="font-bold text-slate-800 text-base text-blue-600">${currencyFormatter.format(inputPrincipal)}</span></div>
                <div><span class="text-slate-500 block text-xs">Importe Bruto Calculado</span><span class="font-bold text-slate-800">${calcMode === 'neto' ? currencyFormatter.format(brutoFinal) : '-'}</span></div>
                <div><span class="text-slate-500 block text-xs">Nº Días</span><span class="font-bold text-slate-800">${inputDias}</span></div>
                <div><span class="text-slate-500 block text-xs">% IRPF</span><span class="font-bold text-slate-800">${inputIRPF}%</span></div>
                <div><span class="text-slate-500 block text-xs">Kilometraje</span><span class="font-bold text-slate-800">${inputKilometraje} km</span></div>
                <div><span class="text-slate-500 block text-xs">Dietas</span><span class="font-bold text-slate-800">${inputDietas} días<br><span class="text-xs font-normal text-slate-600">${dietText}</span></span></div>
                <div><span class="text-slate-500 block text-xs">Gastos Justificados</span><span class="font-bold text-slate-800">${currencyFormatter.format(inputGastos)}</span></div>
                <div class="col-span-2 md:col-span-3 mt-2 pt-2 border-t border-slate-200"><span class="text-slate-500 block text-xs">Material de Alquiler</span><span class="font-bold text-slate-800 text-sm">${materialSummary}</span></div>
            `;
            document.getElementById('pdfSummaryContent').innerHTML = summaryHtml;

            // RENDERIZAR TABLA ZENIT
            const multiDayBody = document.getElementById('multiDayBody');
            const multiDayFoot = document.getElementById('multiDayFoot');
            multiDayBody.innerHTML = '';

            resultadoCalculo.dayResults.forEach((resDia) => {
                const diaNum = resDia.dataOriginal.dia;
                const dData = resDia.dataOriginal;
                const cacheRes = resDia.cache;

                const dayBlock = document.createElement('div');
                dayBlock.className = 'break-inside-avoid flex flex-col border-b border-slate-200 last:border-0';

                let dayHtml = `
                    <div class="bg-blue-50/40 py-2 px-4 font-bold text-blue-800 text-sm border-b border-blue-100 flex items-center">
                        <i class="fa-regular fa-calendar-days mr-2"></i>Día ${diaNum}
                    </div>
                    <div class="flex flex-col divide-y divide-slate-100">
                `;

                // Caché
                dayHtml += `
                    <div class="hover:bg-slate-50 transition-colors text-sm py-3 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                        <div class="font-medium text-slate-700 pl-4 text-xs flex items-center"><i class="fa-solid fa-microphone text-slate-400 mr-2"></i>Caché</div>
                        <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(cacheRes.bruto)}</div>
                        <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(cacheRes.comision)}</div>
                        <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(cacheRes.coste)}</div>
                        <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(cacheRes.segSocial)}</div>
                        <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(cacheRes.irpf)}</div>
                        <div class="text-right tabular-nums text-blue-700 font-bold">${currencyFormatter.format(cacheRes.aLiquidar)}</div>
                    </div>
                `;

                if (dData.km > 0) {
                    const c = dData.km * 0.05; const bl = dData.km - c;
                    dayHtml += `
                        <div class="hover:bg-slate-50 transition-colors text-sm py-3 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                            <div class="font-medium text-slate-700 pl-4 text-xs flex items-center"><i class="fa-solid fa-car text-slate-400 mr-2"></i>Kilometraje</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(dData.km)}</div>
                            <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(c)}</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(bl)}</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right tabular-nums text-blue-700 font-bold">${currencyFormatter.format(bl)}</div>
                        </div>
                    `;
                }

                if (dData.dieta > 0) {
                    const c = dData.dieta * 0.05; const bl = dData.dieta - c;
                    dayHtml += `
                        <div class="hover:bg-slate-50 transition-colors text-sm py-3 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                            <div class="font-medium text-slate-700 pl-4 text-xs flex items-center"><i class="fa-solid fa-utensils text-slate-400 mr-2"></i>Dietas</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(dData.dieta)}</div>
                            <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(c)}</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(bl)}</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right tabular-nums text-blue-700 font-bold">${currencyFormatter.format(bl)}</div>
                        </div>
                    `;
                }

                if (dData.alquiler > 0) {
                    const c = dData.alquiler * 0.05; const bl = dData.alquiler - c;
                    dayHtml += `
                        <div class="hover:bg-slate-50 transition-colors text-sm py-3 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                            <div class="font-medium text-slate-700 pl-4 text-xs flex items-center"><i class="fa-solid fa-guitar text-slate-400 mr-2"></i>Alquiler Material</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(dData.alquiler)}</div>
                            <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(c)}</div>
                            <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(bl)}</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right tabular-nums text-slate-400">-</div>
                            <div class="text-right text-purple-600 font-bold italic">via Taiman</div>
                        </div>
                    `;
                }

                dayHtml += `</div>`;
                dayBlock.innerHTML = dayHtml;
                multiDayBody.appendChild(dayBlock);
            });

            if (resultadoCalculo.gastosRes) {
                const gRes = resultadoCalculo.gastosRes;
                const gastosBlock = document.createElement('div');
                gastosBlock.className = 'break-inside-avoid border-b border-slate-200 bg-slate-100/50';
                gastosBlock.innerHTML = `
                    <div class="hover:bg-slate-50 transition-colors text-sm py-3 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                        <div class="font-bold text-slate-700 text-xs flex items-center"><i class="fa-solid fa-receipt text-slate-400 mr-2"></i>Gastos Justificados</div>
                        <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(gRes.bruto)}</div>
                        <div class="text-right tabular-nums text-red-600">- ${currencyFormatter.format(gRes.comision)}</div>
                        <div class="text-right tabular-nums text-slate-900">${currencyFormatter.format(gRes.baseLiq)}</div>
                        <div class="text-right tabular-nums text-slate-400">-</div>
                        <div class="text-right tabular-nums text-slate-400">-</div>
                        <div class="text-right tabular-nums text-blue-700 font-bold">${currencyFormatter.format(gRes.baseLiq)}</div>
                    </div>
                `;
                multiDayBody.appendChild(gastosBlock);
            }

            const tz = resultadoCalculo.totalsZenit;
            multiDayFoot.innerHTML = `
                <div class="py-4 px-4 grid grid-cols-[2fr_1.2fr_1.2fr_1.2fr_1fr_1fr_1.2fr] items-center">
                    <div class="font-bold text-slate-900 uppercase text-xs tracking-wider">Total Zenit</div>
                    <div class="text-right tabular-nums font-bold text-slate-900">${currencyFormatter.format(tz.bruto)}</div>
                    <div class="text-right tabular-nums font-bold text-red-600">- ${currencyFormatter.format(tz.comision)}</div>
                    <div class="text-right tabular-nums font-bold text-slate-900">${currencyFormatter.format(tz.coste)}</div>
                    <div class="text-right tabular-nums font-bold text-red-600">- ${currencyFormatter.format(tz.segSocial)}</div>
                    <div class="text-right tabular-nums font-bold text-red-600">- ${currencyFormatter.format(tz.irpf)}</div>
                    <div class="text-right tabular-nums font-bold text-blue-700 text-lg" id="resMultiTotal">${currencyFormatter.format(tz.aLiquidar)}</div>
                </div>
            `;

            const totalElement = document.getElementById('resMultiTotal');
            totalElement.classList.add('scale-105', 'transition-transform');
            setTimeout(() => totalElement.classList.remove('scale-105'), 200);

            // RENDERIZAR TABLA TAIMAN
            const taimanSection = document.getElementById('taimanSection');
            const taimanDivider = document.getElementById('taimanDivider');

            if (resultadoCalculo.taimanRes) {
                const tr = resultadoCalculo.taimanRes;
                document.getElementById('resTaimanImporte').textContent = currencyFormatter.format(tr.importe);
                document.getElementById('resTaimanComision').textContent = "- " + currencyFormatter.format(tr.comision);
                document.getElementById('resTaimanBaseLiq').textContent = currencyFormatter.format(tr.baseLiq);
                document.getElementById('resTaimanIRPF').textContent = "- " + currencyFormatter.format(tr.irpf);
                document.getElementById('resTaimanALiquidar').textContent = currencyFormatter.format(tr.aLiquidar);
                
                taimanSection.classList.remove('hidden');
                taimanDivider.classList.remove('hidden');
            } else {
                taimanSection.classList.add('hidden');
                taimanDivider.classList.add('hidden');
            }
        }

        // --- EXPORTACIÓN A PDF ---
        /* Botón PDF temporalmente oculto
        function generarPDF() {
            // ... (Código mantenido para cuando se necesite)
        }
        */
    </script>
</body>
</html>